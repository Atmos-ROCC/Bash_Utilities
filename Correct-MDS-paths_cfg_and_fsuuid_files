 ( ver=1.4.1;echo -e "\E[92m\n\n# Run for which MDS ports?\n#  All ports (a)\n#  Down ports (d)\n\E[0m"; read -s -t 60 -n 1 which_disks; if [[ "$which_disks" =~ [aA] ]] ; then mds_ports_list=( $(service mauimds status | awk -F"_| " '{print $2}') $(service mauiremoterep status | awk -F"_| " '{print $2}') ) ;elif [[ "$which_disks" =~ [dD] ]] ;then mds_ports_list=( $(service mauimds status | awk -F"_| " '!/running/{print $2}') $(service mauiremoterep status | awk -F"_| " '!/running/{print $2}') ) ;else exit 0; fi; for mds_port in ${mds_ports_list[@]}; do echo -n "# mdsdir ${mds_port}: "; awk -F/ 'function red(string) { printf ("%s%s%s", "\033[1;31m", string, "\033[0m "); }; function green(string) { printf ("%s%s%s", "\033[1;32m", string, "\033[0m "); };{if ($2 == "mauimds-db"){print green($0)} else {print red($0)}}' <<< $(mdsdir ${mds_port}); [[ -a /usr/local/maui/etc/maui/mds/${mds_port}/fsuuid ]] && echo -e "# FSUUID found: \E[92m$(cat /usr/local/maui/etc/maui/mds/${mds_port}/fsuuid)\E[0m" || echo -e "\E[31m# File missing: /usr/local/maui/etc/maui/mds/${mds_port}/fsuuid\E[0m"; done;[[ "$(awk -F: '{print $2}' /var/local/maui/mm/maintenance)" =~ "OM" ]] && { echo -e "\E[92m\n\n# If paths incorrect.. go to Maintenance mode? (y/n)) "; read -s -t 60 -n 1 set_maint_mode;[[ "$set_maint_mode" =~ [yY] ]] && netmgr mode set MM -n local; }; echo -e "\E[92m\n\n# Correct issues found? (y/n)) "; read -s -t 60 -n 1 correct_mds_loop; if [[ "$correct_mds_loop" =~ [yY] ]]; then echo -e "# Building symlinks in /mauimds-db";for fsuuid_mnt in $(ls /atmos/* -d1 | cut -d'/' -f3); do ln -s /atmos/${fsuuid_mnt} /mauimds-db/mds-${fsuuid_mnt}; done; echo -e "# Correcting fsuuid files and MDS config files";for mds_port in ${mds_ports_list[@]}; do mds_pdir_tmp=$(ls -d /mauimds-db/mds-*/mds/mds_${mds_port}/[mrs][ael]*[re]) && mdscfg -p ${mds_port} -c "bdbxmlEnvRoot=${mds_pdir_tmp}" && grep EnvRoot /etc/maui/mds/${mds_port}/mds_cfg.xml; done; for mds_port in ${mds_ports_list[@]};do awk -F/ '{print "/mauimds-db/mds-"$3}' <<< $(ls -d /atmos/[[:alnum:]]*/mds/mds_${mds_port} 2>/dev/null || mdsdir ${mds_port} | sed 's,/mauimds-db/mds-,/mauimds-db/,') > /usr/local/maui/etc/maui/mds/${mds_port}/fsuuid; done ; fi; [[ "$(awk -F: '{print $2}' /var/local/maui/mm/maintenance)" =~ "OM" ]] && { echo -e "\E[92m\n\n# Set back to Operational Mode? (y/n)) "; read -s -t 60 -n 1 set_maint_mode;[[ "$set_maint_mode" =~ [yY] ]] && netmgr mode set OM -n local; };echo -e "\E[92m\n\n# Restart all MDS services? (y/n)) "; read -s -t 60 -n 1 restart_mds_serv;[[ "$restart_mds_serv" =~ [yY] ]] && { echo -e "# Restarting affected MDS services";for mds_port in ${mds_ports_list[@]};do service mauimds_${mds_port} restart || service mauimdsremt_${mds_port} restart; done; } )
